---
import { Users, Eye, UserPlus, Globe } from "lucide-react";
import { type Lang } from "../i18n/ui-locales";
import { useTranslations } from "../i18n";

interface Props {
    lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
---

<div id="stats-widget" class="fixed bottom-4 right-4 z-40 opacity-0 transition-opacity duration-500">
    <div class="bg-white/90 dark:bg-gray-900/90 backdrop-blur-xl border border-gray-200 dark:border-gray-700 rounded-2xl shadow-2xl p-4 min-w-[200px]">
        <div class="flex items-center gap-2 mb-3 pb-3 border-b border-gray-200 dark:border-gray-700">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-xs font-medium text-gray-600 dark:text-gray-400">En vivo</span>
        </div>
        
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <Eye className="w-4 h-4 text-blue-500" />
                    <span class="text-sm text-gray-600 dark:text-gray-400">Viendo ahora</span>
                </div>
                <span id="stat-online" class="text-lg font-bold text-gray-900 dark:text-white">0</span>
            </div>
            
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <Globe className="w-4 h-4 text-purple-500" />
                    <span class="text-sm text-gray-600 dark:text-gray-400">Visitantes hoy</span>
                </div>
                <span id="stat-today" class="text-lg font-bold text-gray-900 dark:text-white">0</span>
            </div>
            
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <UserPlus className="w-4 h-4 text-green-500" />
                    <span class="text-sm text-gray-600 dark:text-gray-400">Apuntados</span>
                </div>
                <span id="stat-signups" class="text-lg font-bold text-gray-900 dark:text-white">0</span>
            </div>
        </div>
    </div>
</div>

<script>
    import { getStats, isSupabaseConfigured } from '../lib/supabase';
    
    const updateStats = async () => {
        if (!isSupabaseConfigured()) {
            const widget = document.getElementById('stats-widget');
            if (widget) widget.style.display = 'none';
            return;
        }
        
        const stats = await getStats();
        if (!stats) return;
        
        const onlineEl = document.getElementById('stat-online');
        const todayEl = document.getElementById('stat-today');
        const signupsEl = document.getElementById('stat-signups');
        const widget = document.getElementById('stats-widget');
        
        if (onlineEl) onlineEl.textContent = stats.online_now.toString();
        if (todayEl) todayEl.textContent = stats.today_visitors.toString();
        if (signupsEl) signupsEl.textContent = stats.total_signups.toString();
        if (widget) widget.classList.remove('opacity-0');
    };
    
    updateStats();
    setInterval(updateStats, 30000);
</script>
