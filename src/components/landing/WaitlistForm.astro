---
import { Mail, Bell, CheckCircle, Sparkles, Gift } from "lucide-react";
import { type Lang } from "../../i18n/ui-locales";
import { useTranslations } from "../../i18n";

interface Props {
    lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
---

<section id="waitlist" class="py-12 md:py-24 relative bg-white dark:bg-black">
    <div class="container mx-auto px-6">
        <div class="max-w-xl mx-auto">
            <div class="glass-panel p-8 md:p-10 rounded-3xl text-center">
                <div
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full glass-panel mb-6"
                >
                    <Sparkles className="w-4 h-4 text-purple-500" />
                    <span
                        class="text-sm font-medium text-gray-600 dark:text-gray-400"
                        >{t("waitlist.badge")}</span
                    >
                </div>

                <h2
                    class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white mb-4"
                >
                    {t("waitlist.title")}<br />
                    <span class="text-gradient"
                        >{t("waitlist.titleHighlight")}</span
                    >
                </h2>

                <p class="text-lg text-gray-600 dark:text-gray-400 mb-6">
                    {t("waitlist.subtitle")}
                </p>

                <div
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 mb-8"
                >
                    <Gift className="w-4 h-4 text-green-500" />
                    <span
                        class="text-sm text-green-700 dark:text-green-300 font-medium"
                        >{t("waitlist.discount")}</span
                    >
                </div>

                <form
                    id="waitlist-form"
                    class="flex flex-col sm:flex-row gap-3 mb-6"
                >
                    <div class="relative flex-1">
                        <Mail
                            className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"
                        />
                        <input
                            type="email"
                            name="email"
                            id="waitlist-email"
                            required
                            placeholder={t("waitlist.form.placeholder")}
                            class="w-full pl-12 pr-4 py-3 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                        />
                    </div>
                    <button
                        type="submit"
                        id="waitlist-submit"
                        class="px-6 py-3 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <Bell className="w-4 h-4" />
                        <span id="waitlist-button-text">{t("waitlist.form.button")}</span>
                    </button>
                </form>

                <div id="error-message" class="hidden mb-6">
                    <div
                        class="inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800"
                    >
                        <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span id="error-text" class="text-red-700 dark:text-red-300 font-medium"></span>
                    </div>
                </div>

                <div id="success-message" class="hidden mb-6">
                    <div
                        class="inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800"
                    >
                        <CheckCircle className="w-5 h-5 text-green-500" />
                        <span
                            class="text-green-700 dark:text-green-300 font-medium"
                            >{t("waitlist.success")}</span
                        >
                    </div>
                </div>

                <p class="text-sm text-gray-600 dark:text-gray-400">
                    {t("waitlist.privacy")}
                </p>
            </div>
        </div>
    </div>
</section>

<script>
    import { subscribeToWaitlist, isSupabaseConfigured } from '../../lib/supabase';
    
    const form = document.getElementById('waitlist-form') as HTMLFormElement;
    const emailInput = document.getElementById('waitlist-email') as HTMLInputElement;
    const submitBtn = document.getElementById('waitlist-submit') as HTMLButtonElement;
    const buttonText = document.getElementById('waitlist-button-text');
    const successMsg = document.getElementById('success-message');
    const errorMsg = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = emailInput?.value;
        if (!email) return;
        
        // Disable button
        if (submitBtn) submitBtn.disabled = true;
        if (buttonText) buttonText.textContent = 'Enviando...';
        
        // Hide previous messages
        successMsg?.classList.add('hidden');
        errorMsg?.classList.add('hidden');
        
        try {
            const result = await subscribeToWaitlist(email, 'landing');
            
            if (result.success) {
                successMsg?.classList.remove('hidden');
                form?.classList.add('hidden');
            } else {
                if (errorText) errorText.textContent = result.error || 'Error al enviar';
                errorMsg?.classList.remove('hidden');
                if (submitBtn) submitBtn.disabled = false;
                if (buttonText) buttonText.textContent = 'Unirme';
            }
        } catch (error) {
            if (errorText) errorText.textContent = 'Error de conexi√≥n';
            errorMsg?.classList.remove('hidden');
            if (submitBtn) submitBtn.disabled = false;
            if (buttonText) buttonText.textContent = 'Unirme';
        }
    });
    
    // Check URL for success param (fallback for non-JS)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('subscribed') === 'true') {
        successMsg?.classList.remove('hidden');
        form?.classList.add('hidden');
        window.history.replaceState({}, document.title, window.location.pathname);
    }
</script>
