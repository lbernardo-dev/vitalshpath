---
import { Mail, Bell, CheckCircle, Sparkles, Gift } from "lucide-react";
import { type Lang } from "../../i18n/ui-locales";
import { useTranslations } from "../../i18n";

interface Props {
    lang: Lang;
    showDecorations?: boolean;
}

const { lang, showDecorations = false } = Astro.props;
const t = useTranslations(lang);
---

<div class="w-full">
    {
        showDecorations && (
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 mb-6">
                    <Sparkles className="w-4 h-4 text-purple-500" />
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">
                        {t("waitlist.badge")}
                    </span>
                </div>
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
                    {t("waitlist.title")}
                </h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">
                    {t("waitlist.subtitle")}
                </p>
            </div>
        )
    }

    <form
        id="waitlist-form"
        class="w-full relative liquid-glass rounded-full flex items-center p-1.5 sm:p-2 focus-within:ring-2 focus-within:ring-cyan-500 transition-all shadow-lg hover:shadow-xl"
    >
        <Mail
            className="absolute left-5 sm:left-6 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500 dark:text-gray-400 pointer-events-none"
        />
        <input
            type="email"
            name="email"
            id="waitlist-email"
            required
            placeholder={t("waitlist.form.placeholder")}
            class="flex-1 w-full pl-12 sm:pl-14 pr-2 py-3 sm:py-3.5 bg-transparent border-none text-base sm:text-[17px] text-gray-900 dark:text-white placeholder:text-gray-500 focus:outline-none focus:ring-0 text-ellipsis"
        />
        <button
            type="submit"
            id="waitlist-submit"
            class="shrink-0 px-6 sm:px-8 py-3 bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold rounded-full shadow-md hover:-translate-y-0.5 active:translate-y-0 active:scale-95 transition-all flex items-center justify-center gap-2 group hover:bg-cyan-500 dark:hover:bg-cyan-400 dark:hover:text-gray-900"
        >
            <span
                id="waitlist-button-text"
                class="whitespace-nowrap text-sm sm:text-base"
                >{t("waitlist.form.button")}</span
            >
            <Bell
                className="w-4 h-4 sm:w-5 sm:h-5 group-hover:rotate-12 transition-transform"
            />
        </button>
    </form>

    <div id="error-message" class="hidden mt-4">
        <div
            class="flex items-center gap-2 px-4 py-3 rounded-xl bg-red-500/10 border border-red-500/20"
        >
            <svg
                class="w-5 h-5 text-red-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
            </svg>
            <span id="error-text" class="text-red-500 font-medium text-sm"
            ></span>
        </div>
    </div>

    <div id="success-message" class="hidden mt-4">
        <div
            class="flex items-center gap-2 px-4 py-4 rounded-2xl bg-green-500/10 border border-green-500/20 text-center justify-center"
        >
            <CheckCircle className="w-6 h-6 text-green-500" />
            <span class="text-green-500 font-bold">{t("waitlist.success")}</span
            >
        </div>
    </div>
</div>

<script>
    import {
        subscribeToWaitlist,
        isSupabaseConfigured,
    } from "../../lib/supabase";

    // We use querySelectorAll to handle multiple instances of the form if they exist
    const forms = document.querySelectorAll<HTMLFormElement>("#waitlist-form");

    forms.forEach((form) => {
        const emailInput = form.querySelector(
            'input[type="email"]'
        ) as HTMLInputElement;
        const submitBtn = form.querySelector(
            'button[type="submit"]'
        ) as HTMLButtonElement;
        const buttonText = form.querySelector("#waitlist-button-text");
        const successMsg =
            form.parentElement?.querySelector("#success-message");
        const errorMsg = form.parentElement?.querySelector("#error-message");
        const errorText = form.parentElement?.querySelector("#error-text");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const email = emailInput?.value.trim();
            if (!email) return;

            // Basic email validation regex
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                if (errorText)
                    errorText.textContent =
                        "Por favor, introduce un email válido.";
                errorMsg?.classList.remove("hidden");
                emailInput?.focus();
                return;
            }

            if (submitBtn) submitBtn.disabled = true;
            if (buttonText) buttonText.textContent = "...";

            successMsg?.classList.add("hidden");
            errorMsg?.classList.add("hidden");

            try {
                const result = await subscribeToWaitlist(email, "landing");

                if (result.success) {
                    successMsg?.classList.remove("hidden");
                    form.classList.add("hidden");
                } else {
                    if (errorText)
                        errorText.textContent = result.error || "Error";
                    errorMsg?.classList.remove("hidden");
                    if (submitBtn) submitBtn.disabled = false;
                    if (buttonText)
                        buttonText.textContent = t("waitlist.form.button");
                }
            } catch (error) {
                if (errorText)
                    errorText.textContent =
                        "Error de conexión. Inténtalo de nuevo.";
                errorMsg?.classList.remove("hidden");
                if (submitBtn) submitBtn.disabled = false;
                if (buttonText)
                    buttonText.textContent = t("waitlist.form.button");
            }
        });
    });
</script>
