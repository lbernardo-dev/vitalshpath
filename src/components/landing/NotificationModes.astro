---
import {
    Bell,
    VolumeX,
    Vibrate,
    BellOff,
    CheckCircle2,
    Info,
    Pill,
    Clock,
} from "lucide-react";
import { type Lang } from "../../i18n/ui-locales";
import { useTranslations } from "../../i18n";
import DeviceMockup from "../DeviceMockup.astro";

interface Props {
    lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);

const modes = [
    { id: "normal", icon: Bell, color: "blue", key: "normal" },
    { id: "quiet", icon: VolumeX, color: "purple", key: "quiet" },
    { id: "discrete", icon: Vibrate, color: "slate", key: "discrete" },
    { id: "off", icon: BellOff, color: "gray", key: "off" }
];
---

<section
    id="notification-modes"
    class="py-24 relative overflow-hidden bg-white dark:bg-black"
>
    <!-- ... same as before, skipping to simulator ... -->
    <div class="container mx-auto px-6 relative z-10">
        <div class="flex flex-col lg:flex-row items-center gap-16">
            
            <!-- Left: Info & Mode Selection -->
            <div class="flex-1 reveal">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 mb-6 font-bold text-xs uppercase tracking-widest text-blue-500">
                    <CheckCircle2 className="w-3 h-3" />
                    {t("notificationModes.badge")}
                </div>
                <h2 class="text-4xl md:text-5xl font-black text-gray-900 dark:text-white mb-6 tracking-tight italic">
                    {t("notificationModes.title")}
                </h2>
                <p class="text-xl text-gray-600 dark:text-white/60 mb-10 leading-relaxed">
                    {t("notificationModes.subtitle")}
                </p>

                <!-- Interactive Mode Buttons -->
                <div class="grid grid-cols-1 gap-4" id="mode-triggers-container">
                    {modes.map((mode) => (
                        <button
                            data-mode-trigger={mode.id}
                            data-title={t(`notificationModes.modes.${mode.key}.title`)}
                            data-desc={t(`notificationModes.modes.${mode.key}.desc`)}
                            class="group flex items-center gap-6 p-6 rounded-[2rem] bg-gray-50/50 dark:bg-white/5 border-2 border-transparent dark:border-white/5 hover:border-blue-500/20 dark:hover:border-white/20 transition-all duration-300 text-left relative overflow-hidden active:scale-[0.98]"
                        >
                            <div class={`w-14 h-14 rounded-2xl flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform bg-${mode.color}-100 dark:bg-${mode.color}-500/20`}>
                                <mode.icon className={`w-7 h-7 text-${mode.color}-600 dark:text-${mode.color}-300`} />
                            </div>
                            <div class="flex-1">
                                <h4 class="text-xl font-black text-gray-900 dark:text-white uppercase tracking-tight mb-1">
                                    {t(`notificationModes.modes.${mode.key}.title`)}
                                </h4>
                                <p class="text-base text-gray-500 dark:text-white/40 font-medium leading-tight">
                                    {t(`notificationModes.modes.${mode.key}.desc`)}
                                </p>
                            </div>
                            
                            <!-- Selection Indicator -->
                            <div class="checkmark-wrapper opacity-0 group-[.active]:opacity-100 transition-all duration-500 translate-x-4 group-[.active]:translate-x-0">
                                <CheckCircle2 className="w-6 h-6 text-blue-500 dark:text-blue-400" />
                            </div>
                        </button>
                    ))}
                </div>
                
                <div class="mt-8 p-4 rounded-2xl bg-blue-500/5 border border-blue-500/10 flex items-center gap-3">
                    <Info className="w-5 h-5 text-blue-500 shrink-0" />
                    <p class="text-xs text-blue-600 dark:text-blue-300 font-medium leading-relaxed">
                        {t("notificationModes.hapticTip")}
                    </p>
                </div>
            </div>

            <!-- Right: Interactive Phone Simulator -->
            <div class="flex-1 flex justify-center perspective-[2000px] w-full h-[580px] lg:h-[700px] reveal-right relative">
                
                <!-- Haptic Engine Background Effect - INDUSTRIAL PREMIUM -->
                <div class="absolute -right-5 lg:-right-32 top-1/2 -translate-y-[60%] lg:-translate-y-1/2 w-[650px] h-[650px] -z-10 pointer-events-none scale-[0.6] lg:scale-100 origin-center">
                    <!-- Tech Atmosphere Glow (Ambient) -->
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-600/20 via-indigo-600/15 to-transparent blur-[140px] rounded-full dark:from-blue-500/30 dark:via-indigo-500/20 dark:opacity-70"></div>
                    
                    <!-- Haptic Orbital System -->
                    <div class="haptic-rings absolute right-0 top-1/2 -translate-y-1/2 flex items-center justify-center">
                        <!-- Primary Field -->
                        <div class="ring-item w-64 h-64 border-2 border-indigo-500/40 dark:border-indigo-400/60 rounded-full bg-indigo-500/5 shadow-[0_0_60px_rgba(99,102,241,0.2)] dark:shadow-[0_0_100px_rgba(99,102,241,0.4)]"></div>
                        <!-- Secondary Pulse Layer -->
                        <div class="ring-item w-96 h-96 border border-blue-500/20 dark:border-blue-400/40 rounded-full bg-blue-500/5 animate-pulse-slow"></div>
                        <!-- Outer Boundary -->
                        <div class="ring-item w-[500px] h-[500px] border border-slate-500/10 dark:border-white/5 rounded-full scale-110"></div>
                        
                        <!-- Magnetic Field Flux Lines (More detailed) -->
                        <div class="absolute right-0 top-1/2 -translate-y-1/2 w-[400px] h-[1px] bg-gradient-to-r from-transparent via-blue-400/40 to-transparent rotate-45"></div>
                        <div class="absolute right-0 top-1/2 -translate-y-1/2 w-[400px] h-[1px] bg-gradient-to-r from-transparent via-indigo-400/40 to-transparent -rotate-45"></div>
                        <div class="absolute right-0 top-1/2 -translate-y-1/2 w-[450px] h-[1px] bg-gradient-to-r from-transparent via-slate-400/10 to-transparent rotate-12"></div>
                        <div class="absolute right-0 top-1/2 -translate-y-1/2 w-[450px] h-[1px] bg-gradient-to-r from-transparent via-slate-400/10 to-transparent -rotate-12"></div>
                        
                        <!-- The "Taptic Engine" Hardware Unit -->
                        <div class="absolute -right-8 top-1/2 -translate-y-1/2 w-40 h-80 bg-[#E5E7EB] dark:bg-[#121214] border border-white/20 dark:border-white/5 backdrop-blur-3xl rounded-[2.5rem] shadow-[-20px_0_50px_rgba(0,0,0,0.2)] dark:shadow-[-20px_0_80px_rgba(0,0,0,0.6)] overflow-hidden skew-y-2 group-hover:skew-y-0 transition-transform duration-1000">
                            <!-- Hardware Texture (Micro-mesh) -->
                            <div class="absolute inset-0 opacity-[0.03] dark:opacity-[0.1] bg-[radial-gradient(#000_1px,transparent_1px)] dark:bg-[radial-gradient(#fff_1px,transparent_1px)] bg-[size:4px_4px]"></div>
                            
                            <!-- Internal Components Detail -->
                            <div class="absolute inset-4 rounded-[1.5rem] border border-black/5 dark:border-white/5 bg-gradient-to-br from-white/50 to-transparent dark:from-white/10 flex flex-col items-center justify-between p-6">
                                <div class="w-8 h-1 rounded-full bg-black/10 dark:bg-white/10"></div>
                                
                                <!-- Core Energy Source -->
                                <div class="relative w-2 h-40 bg-slate-200 dark:bg-zinc-800 rounded-full overflow-hidden">
                                    <div class="absolute inset-0 bg-blue-500 shadow-[0_0_20px_#3b82f6,0_0_40px_rgba(59,130,246,0.5)] animate-pulse-fast"></div>
                                    <!-- Scanning Light Effect -->
                                    <div class="absolute top-0 left-0 w-full h-1/4 bg-white/80 blur-sm animate-scan"></div>
                                </div>
                                
                                <span class="text-[7px] font-black tracking-[0.3em] uppercase text-black/20 dark:text-white/20 rotate-90">Taptic System</span>
                            </div>
                            
                            <!-- Glass Reflection -->
                            <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/20 dark:via-white/5 to-transparent pointer-events-none"></div>
                        </div>
                    </div>
                </div>

                <div id="notif-simulator" class="relative w-[310px] h-[672px] transform scale-[0.85] lg:scale-100 origin-top group">
                    <DeviceMockup model="iphone17">
                        <div class="w-full h-full bg-[#F3F4F6] dark:bg-[#0a0a0b] p-6 flex flex-col pt-20">
                            <!-- Simulated Alert -->
                            <div id="simulated-alert" class="w-full p-4 rounded-2xl bg-white dark:bg-white/10 backdrop-blur-xl border border-white/20 shadow-2xl transform transition-all duration-700 opacity-0 -translate-y-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-blue-500 flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
                                        <Bell className="w-6 h-6" />
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center mb-0.5">
                                            <span class="text-[9px] font-black uppercase tracking-[0.2em] text-blue-500">VitalsPath</span>
                                            <span class="text-[8px] text-gray-400 dark:text-gray-500 font-bold uppercase tracking-widest">{t("notificationModes.simulator.now")}</span>
                                        </div>
                                        <p class="text-xs font-black text-gray-900 dark:text-white leading-tight">{t("notificationModes.simulator.doseTitle")}</p>
                                        <p id="alert-status-text" class="text-[10px] text-gray-400 dark:text-gray-500 font-medium">Normal</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Screen Background Content (Matching Photo) -->
                            <div class="flex-1 mt-6 space-y-4">
                                <div class="w-full h-32 rounded-2xl bg-white dark:bg-white/5 border border-black/5 dark:border-white/10 p-4 flex flex-col gap-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg bg-pink-100 dark:bg-pink-500/20"></div>
                                        <div class="flex-1 space-y-1.5">
                                            <div class="w-3/4 h-2 rounded-full bg-gray-200 dark:bg-white/10 opacity-50"></div>
                                            <div class="w-1/2 h-1.5 rounded-full bg-gray-100 dark:bg-white/5 opacity-30"></div>
                                        </div>
                                    </div>
                                    <div class="w-full h-px bg-gray-100 dark:bg-white/10"></div>
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-500/20"></div>
                                        <div class="flex-1 space-y-1.5">
                                            <div class="w-1/2 h-2 rounded-full bg-gray-200 dark:bg-white/10 opacity-50"></div>
                                            <div class="w-1/3 h-1.5 rounded-full bg-gray-100 dark:bg-white/5 opacity-30"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="h-24 rounded-2xl bg-indigo-50 dark:bg-indigo-500/10 opacity-50"></div>
                                    <div class="h-24 rounded-2xl bg-purple-50 dark:bg-purple-500/10 opacity-50"></div>
                                </div>
                            </div>
                        </div>
                    </DeviceMockup>

                    <!-- Status Indicator Floating -->
                    <div class="absolute -right-2 sm:-right-6 top-1/2 -translate-y-1/2 z-20 pointer-events-none">
                        <div id="mode-badge" class="px-3 py-1.5 rounded-lg bg-gray-900 dark:bg-white text-white dark:text-black text-[8px] font-black uppercase tracking-[0.2em] shadow-2xl transition-all duration-500 border border-white/10">
                            {t("notificationModes.simulator.ready")}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    [data-mode-trigger].active {
        background-color: white;
        border-color: #3b82f6;
        box-shadow: 0 20px 40px -10px rgba(0,0,0,0.05);
        transform: translateY(-2px);
    }
    
    :global(.dark) [data-mode-trigger].active {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: #60a5fa;
        box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
    }

    [data-mode-trigger].active .w-14 {
        background-color: #eff6ff;
    }
    
    :global(.dark) [data-mode-trigger].active .w-14 {
        background-color: #1e3a8a33;
    }

    .ripple-circle {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        border: 2px solid rgba(59, 130, 246, 0.3);
        border-radius: 50%;
        opacity: 0;
        pointer-events: none;
    }

    .haptic-active .ripple-circle {
        animation: ripple 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }

    @keyframes ripple {
        0% { width: 30%; height: 30%; opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        50% { opacity: 0.5; }
        100% { width: 140%; height: 140%; opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
    }

    .animate-pulse-slow {
        animation: pulse-slow 8s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse-slow {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
    }

    .haptic-rings {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ring-item {
        position: absolute;
        animation: ring-pulse 4s ease-out infinite;
    }

    @keyframes ring-pulse {
        0% { transform: scale(0.8); opacity: 0; }
        50% { opacity: 0.5; }
        100% { transform: scale(1.2); opacity: 0; }
    }

    .haptic-active .haptic-rings .ring-item {
        animation-duration: 1s;
        border-color: rgba(59, 130, 246, 0.5);
    }

    .animate-pulse-fast {
        animation: pulse-fast 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse-fast {
        0%, 100% { opacity: 0.6; transform: scaleY(1); }
        50% { opacity: 1; transform: scaleY(1.05); }
    }

    .animate-scan {
        animation: scan 3s linear infinite;
    }

    @keyframes scan {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(400%); }
    }
</style>

<script>
    function setupSimulator() {
        const triggers = document.querySelectorAll('[data-mode-trigger]');
        const alert = document.getElementById('simulated-alert');
        const alertText = document.getElementById('alert-status-text');
        const modeBadge = document.getElementById('mode-badge');
        const container = document.getElementById('notif-simulator');
        
        const modeColors = {
            normal: "bg-blue-600",
            quiet: "bg-purple-600",
            discrete: "bg-indigo-600",
            off: "bg-gray-600"
        };

        triggers.forEach(trigger => {
            trigger.addEventListener('click', () => {
                const mode = trigger.getAttribute('data-mode-trigger');
                const title = trigger.getAttribute('data-title');
                const desc = trigger.getAttribute('data-desc');
                
                // Reset states
                triggers.forEach(t => t.classList.remove('active'));
                trigger.classList.add('active');
                container?.classList.remove('haptic-active');
                
                // Animate Alert
                if (alert && modeBadge) {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(-16px)';
                    
                    setTimeout(() => {
                        if (alertText) alertText.textContent = desc;
                        modeBadge.textContent = title;
                        
                        // Fix for class removal/addition
                        modeBadge.className = `px-5 py-2.5 rounded-full text-white text-[11px] font-black uppercase tracking-[0.2em] shadow-2xl transition-all duration-500 border border-white/10 ${modeColors[mode] || 'bg-gray-900'}`;
                        
                        alert.style.opacity = '1';
                        alert.style.transform = 'translateY(0)';
                        
                        if (mode === 'discrete') {
                            container?.classList.add('haptic-active');
                        }
                    }, 300);
                }
            });
        });

        // Trigger first mode by default
        if (triggers[0]) (triggers[0] as HTMLElement).click();
    }

    // Initialize on load and after swap
    setupSimulator();
    document.addEventListener('astro:after-swap', setupSimulator);
</script>
