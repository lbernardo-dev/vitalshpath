---
import { getSupabase } from "../lib/supabase";
import { type Lang } from "../i18n/ui-locales";
import { useTranslations } from "../i18n";
import { ClipboardList, X, CheckCircle2 } from "lucide-react";

interface Props {
    lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
const supabase = getSupabase();
---

<div
    id="survey-container"
    class="hidden fixed bottom-6 right-6 z-50 max-w-sm w-[calc(100%-3rem)]"
    data-lang={lang}
    data-t-question={t("survey.question")}
    data-t-yes={t("survey.options.yes")}
    data-t-no={t("survey.options.no")}
    data-t-maybe={t("survey.options.maybe")}
>
    <div
        class="liquid-glass p-6 shadow-2xl transition-all duration-500 hover:scale-[1.01] border-blue-500/20"
    >
        <button
            id="close-survey-widget"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-white transition-colors"
            aria-label="Close survey"
        >
            <X className="w-5 h-5" />
        </button>

        <div id="survey-content">
            <div class="flex items-center gap-2 mb-4">
                <div
                    class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center"
                >
                    <ClipboardList className="w-4 h-4 text-blue-500" />
                </div>
                <span
                    class="text-[10px] uppercase tracking-widest font-black text-blue-500"
                    >{t("survey.badge")}</span
                >
            </div>

            <h3
                id="survey-question-text"
                class="text-base font-bold text-gray-900 dark:text-white mb-5 leading-tight"
            >
                ...
            </h3>

            <div id="survey-options-container" class="grid grid-cols-1 gap-2">
                <!-- Options will be injected here -->
            </div>
        </div>

        <div id="survey-thanks" class="hidden text-center py-6">
            <div
                class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4"
            >
                <CheckCircle2
                    className="w-8 h-8 text-blue-500 animate-bounce"
                />
            </div>
            <p class="text-lg font-bold text-gray-900 dark:text-white">
                {t("survey.thanks")}
            </p>
        </div>
    </div>
</div>

<script>
    import { getSupabase } from "../lib/supabase";

    const supabase = getSupabase();
    let currentSurveyId = null;

    async function initSurvey() {
        if (!supabase) return;

        if (sessionStorage.getItem("vp_survey_closed")) return;

        const { data: survey, error } = await supabase
            .from("surveys")
            .select("*")
            .eq("is_active", true)
            .single();

        if (error || !survey) return;

        currentSurveyId = survey.id;
        const container = document.getElementById("survey-container");
        const questionEl = document.getElementById("survey-question-text");
        const optionsEl = document.getElementById("survey-options-container");

        if (container && questionEl && optionsEl) {
            const lang = container.getAttribute("data-lang");
            const tQuestion = container.getAttribute("data-t-question");
            const tYes = container.getAttribute("data-t-yes");
            const tNo = container.getAttribute("data-t-no");
            const tMaybe = container.getAttribute("data-t-maybe");

            // Localized fallback for the standard survey
            if (lang !== "es") {
                questionEl.textContent = tQuestion;
                optionsEl.innerHTML = `
                    <button class="survey-option-btn w-full text-left px-5 py-3 text-sm font-bold text-gray-700 dark:text-gray-300 bg-white/50 dark:bg-white/5 hover:bg-blue-500 hover:text-white dark:hover:bg-blue-500 dark:hover:text-white rounded-2xl border border-gray-100 dark:border-white/5 hover:border-blue-500 transition-all duration-300 shadow-sm hover:shadow-lg hover:shadow-blue-500/20" data-option="Yes">
                        ${tYes}
                    </button>
                    <button class="survey-option-btn w-full text-left px-5 py-3 text-sm font-bold text-gray-700 dark:text-gray-300 bg-white/50 dark:bg-white/5 hover:bg-blue-500 hover:text-white dark:hover:bg-blue-500 dark:hover:text-white rounded-2xl border border-gray-100 dark:border-white/5 hover:border-blue-500 transition-all duration-300 shadow-sm hover:shadow-lg hover:shadow-blue-500/20" data-option="No">
                        ${tNo}
                    </button>
                    <button class="survey-option-btn w-full text-left px-5 py-3 text-sm font-bold text-gray-700 dark:text-gray-300 bg-white/50 dark:bg-white/5 hover:bg-blue-500 hover:text-white dark:hover:bg-blue-500 dark:hover:text-white rounded-2xl border border-gray-100 dark:border-white/5 hover:border-blue-500 transition-all duration-300 shadow-sm hover:shadow-lg hover:shadow-blue-500/20" data-option="Maybe">
                        ${tMaybe}
                    </button>
                `;
            } else {
                questionEl.textContent = survey.question;
                optionsEl.innerHTML = survey.options
                    .map(
                        (opt) => `
                    <button 
                        class="survey-option-btn w-full text-left px-5 py-3 text-sm font-bold text-gray-700 dark:text-gray-300 bg-white/50 dark:bg-white/5 hover:bg-blue-500 hover:text-white dark:hover:bg-blue-500 dark:hover:text-white rounded-2xl border border-gray-100 dark:border-white/5 hover:border-blue-500 transition-all duration-300 shadow-sm hover:shadow-lg hover:shadow-blue-500/20"
                        data-option="${opt}"
                    >
                        ${opt}
                    </button>
                `
                    )
                    .join("");
            }

            setTimeout(() => {
                container.classList.remove("hidden");
                container.classList.add("reveal-visible");
            }, 3000);

            document.querySelectorAll(".survey-option-btn").forEach((btn) => {
                btn.addEventListener("click", async (e) => {
                    const option = e.currentTarget.getAttribute("data-option");
                    await vote(option);
                });
            });
        }
    }

    async function vote(option) {
        if (!supabase || !currentSurveyId) return;

        const { error } = await supabase.from("survey_responses").insert({
            survey_id: currentSurveyId,
            selected_option: option,
            visitor_id: localStorage.getItem("vitalspath_visitor_id"),
        });

        if (!error) {
            document.getElementById("survey-content").classList.add("hidden");
            document.getElementById("survey-thanks").classList.remove("hidden");
            setTimeout(() => {
                const container = document.getElementById("survey-container");
                container.classList.add("opacity-0", "translate-y-10");
                setTimeout(() => {
                    container.classList.add("hidden");
                }, 500);
                sessionStorage.setItem("vp_survey_closed", "true");
            }, 3000);
        }
    }

    document
        .getElementById("close-survey-widget")
        ?.addEventListener("click", () => {
            const container = document.getElementById("survey-container");
            container.classList.add("opacity-0", "translate-y-10");
            setTimeout(() => {
                container.classList.add("hidden");
            }, 500);
            sessionStorage.setItem("vp_survey_closed", "true");
        });

    initSurvey();
</script>

<style>
    #survey-container {
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        transform: translateY(30px);
        opacity: 0;
    }
    #survey-container.reveal-visible {
        transform: translateY(0);
        opacity: 1;
    }
</style>
